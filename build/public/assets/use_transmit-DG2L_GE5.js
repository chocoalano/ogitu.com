import{h as W,q as X,x as $}from"./app-CyjtdGoI.js";var H=(e,t,i)=>{if(!t.has(e))throw TypeError("Cannot "+i)},n=(e,t,i)=>(H(e,t,"read from private field"),i?i.call(e):t.get(e)),r=(e,t,i)=>{if(t.has(e))throw TypeError("Cannot add the same private member more than once");t instanceof WeakSet?t.add(e):t.set(e,i)},c=(e,t,i,a)=>(H(e,t,"write to private field"),t.set(e,i),i),Y=(e,t,i,a)=>({set _(p){c(e,t,p)},get _(){return n(e,t,a)}}),v=(e,t,i)=>(H(e,t,"access private method"),i),U={Pending:0,Created:1,Deleted:2},_={Initializing:"initializing",Connecting:"connecting",Connected:"connected",Disconnected:"disconnected",Reconnecting:"reconnecting"},S,f,w,D,y,k,Z=class{constructor(e){r(this,S,void 0),r(this,f,void 0),r(this,w,void 0),r(this,D,void 0),r(this,y,new Set),r(this,k,U.Pending),c(this,w,e.channel),c(this,S,e.httpClient),c(this,f,e.hooks),c(this,D,e.getEventSourceStatus)}get isCreated(){return n(this,k)===U.Created}get isDeleted(){return n(this,k)===U.Deleted}get handlerCount(){return n(this,y).size}$runHandler(e){for(const t of n(this,y))t(e)}async create(){if(!this.isCreated)return this.forceCreate()}async forceCreate(){if(n(this,D).call(this)!==_.Connected)return new Promise(t=>{setTimeout(()=>{t(this.create())},100)});const e=n(this,S).createRequest("/__transmit/subscribe",{channel:n(this,w)});n(this,f)?.beforeSubscribe(e);try{const t=await n(this,S).send(e);if(t.text(),!t.ok){n(this,f)?.onSubscribeFailed(t);return}c(this,k,U.Created),n(this,f)?.onSubscription(n(this,w))}catch{}}async delete(){if(this.isDeleted||!this.isCreated)return;const e=n(this,S).createRequest("/__transmit/unsubscribe",{channel:n(this,w)});n(this,f)?.beforeUnsubscribe(e);try{const t=await n(this,S).send(e);if(t.text(),!t.ok)return;c(this,k,U.Deleted),n(this,f)?.onUnsubscription(n(this,w))}catch{}}onMessage(e){return n(this,y).add(e),()=>{n(this,y).delete(e)}}onMessageOnce(e){const t=this.onMessage(i=>{e(i),t()})}};S=new WeakMap;f=new WeakMap;w=new WeakMap;D=new WeakMap;y=new WeakMap;k=new WeakMap;var O,N,z,j=class{constructor(e){r(this,N),r(this,O,void 0),c(this,O,e)}send(e){return fetch(e)}createRequest(e,t){return new Request(`${n(this,O).baseUrl}${e}`,{method:"POST",headers:{"Content-Type":"application/json","X-XSRF-TOKEN":v(this,N,z).call(this)??""},body:JSON.stringify({uid:n(this,O).uid,...t}),credentials:"include"})}};O=new WeakMap;N=new WeakSet;z=function(){if(typeof document>"u")return null;const e=document.cookie.match(new RegExp("(^|;\\s*)(XSRF-TOKEN)=([^;]*)"));return e?decodeURIComponent(e[3]):null};var u={BeforeSubscribe:"beforeSubscribe",BeforeUnsubscribe:"beforeUnsubscribe",OnReconnectAttempt:"onReconnectAttempt",OnReconnectFailed:"onReconnectFailed",OnSubscribeFailed:"onSubscribeFailed",OnSubscription:"onSubscription",OnUnsubscription:"onUnsubscription"},l,ee=class{constructor(){r(this,l,new Map)}register(e,t){return n(this,l).has(e)||n(this,l).set(e,new Set),n(this,l).get(e)?.add(t),this}beforeSubscribe(e){return n(this,l).get(u.BeforeSubscribe)?.forEach(t=>t(e)),this}beforeUnsubscribe(e){return n(this,l).get(u.BeforeUnsubscribe)?.forEach(t=>t(e)),this}onReconnectAttempt(e){return n(this,l).get(u.OnReconnectAttempt)?.forEach(t=>t(e)),this}onReconnectFailed(){return n(this,l).get(u.OnReconnectFailed)?.forEach(e=>e()),this}onSubscribeFailed(e){return n(this,l).get(u.OnSubscribeFailed)?.forEach(t=>t(e)),this}onSubscription(e){return n(this,l).get(u.OnSubscription)?.forEach(t=>t(e)),this}onUnsubscription(e){return n(this,l).get(u.OnUnsubscription)?.forEach(t=>t(e)),this}};l=new WeakMap;var m,R,g,I,d,T,b,A,C,M,x,B,G,L,J,P,K,te=class{constructor(e){r(this,M),r(this,B),r(this,L),r(this,P),r(this,m,void 0),r(this,R,void 0),r(this,g,new Map),r(this,I,void 0),r(this,d,void 0),r(this,T,_.Initializing),r(this,b,void 0),r(this,A,void 0),r(this,C,0),typeof e.uidGenerator>"u"&&(e.uidGenerator=()=>crypto.randomUUID()),typeof e.eventSourceFactory>"u"&&(e.eventSourceFactory=(...t)=>new EventSource(...t)),typeof e.eventTargetFactory>"u"&&(e.eventTargetFactory=()=>new EventTarget),typeof e.httpClientFactory>"u"&&(e.httpClientFactory=(t,i)=>new j({baseUrl:t,uid:i})),typeof e.maxReconnectAttempts>"u"&&(e.maxReconnectAttempts=5),c(this,m,e.uidGenerator()),c(this,A,e.eventTargetFactory()),c(this,d,new ee),c(this,I,e.httpClientFactory(e.baseUrl,n(this,m))),e.beforeSubscribe&&n(this,d).register(u.BeforeSubscribe,e.beforeSubscribe),e.beforeUnsubscribe&&n(this,d).register(u.BeforeUnsubscribe,e.beforeUnsubscribe),e.onReconnectAttempt&&n(this,d).register(u.OnReconnectAttempt,e.onReconnectAttempt),e.onReconnectFailed&&n(this,d).register(u.OnReconnectFailed,e.onReconnectFailed),e.onSubscribeFailed&&n(this,d).register(u.OnSubscribeFailed,e.onSubscribeFailed),e.onSubscription&&n(this,d).register(u.OnSubscription,e.onSubscription),e.onUnsubscription&&n(this,d).register(u.OnUnsubscription,e.onUnsubscription),c(this,R,e),v(this,B,G).call(this)}get uid(){return n(this,m)}subscription(e){const t=new Z({channel:e,httpClient:n(this,I),hooks:n(this,d),getEventSourceStatus:()=>n(this,T)});return n(this,g).has(e)?n(this,g).get(e):(n(this,g).set(e,t),t)}on(e,t){n(this,A)?.addEventListener(e,t)}close(){n(this,b)?.close()}};m=new WeakMap;R=new WeakMap;g=new WeakMap;I=new WeakMap;d=new WeakMap;T=new WeakMap;b=new WeakMap;A=new WeakMap;C=new WeakMap;M=new WeakSet;x=function(e){c(this,T,e),n(this,A)?.dispatchEvent(new CustomEvent(e))};B=new WeakSet;G=function(){v(this,M,x).call(this,_.Connecting);const e=new URL(`${n(this,R).baseUrl}/__transmit/events`);e.searchParams.append("uid",n(this,m)),c(this,b,n(this,R).eventSourceFactory(e,{withCredentials:!0})),n(this,b).addEventListener("message",v(this,L,J).bind(this)),n(this,b).addEventListener("error",v(this,P,K).bind(this)),n(this,b).addEventListener("open",()=>{v(this,M,x).call(this,_.Connected),c(this,C,0);for(const t of n(this,g).values())t.isCreated&&t.forceCreate()})};L=new WeakSet;J=function(e){const t=JSON.parse(e.data),i=n(this,g).get(t.channel);if(!(typeof i>"u"))try{i.$runHandler(t.payload)}catch(a){console.log(a)}};P=new WeakSet;K=function(){if(n(this,T)!==_.Reconnecting&&v(this,M,x).call(this,_.Disconnected),v(this,M,x).call(this,_.Reconnecting),n(this,d).onReconnectAttempt(n(this,C)+1),n(this,R).maxReconnectAttempts&&n(this,C)>=n(this,R).maxReconnectAttempts){n(this,b).close(),n(this,d).onReconnectFailed();return}Y(this,C)._++};let q=null;function Q(){return q||(q=new te({baseUrl:typeof globalThis.window<"u"?globalThis.window.location.origin:""})),q}function ie(){const e=W([]),t=W(0),i=W(!1);let a=null;const p=async()=>{if(a)return;const o=Q(),h="admin/notifications";try{a=o.subscription(h),await a.create(),a.onMessage(s=>{s.event==="new_notification"&&(e.value.unshift({id:s.id,type:s.type,title:s.title,message:s.message,data:null,isRead:s.isRead,createdAt:s.createdAt,icon:s.icon,color:s.color}),s.isRead||t.value++)}),i.value=!0}catch(s){console.error("Failed to connect to admin notifications channel:",s),i.value=!1}},F=async()=>{a&&(await a.delete(),a=null,i.value=!1)};return X(()=>{p()}),$(()=>{F()}),{notifications:e,unreadCount:t,isConnected:i,connect:p,disconnect:F,setNotifications:o=>{e.value=o},setUnreadCount:o=>{t.value=o},markAsRead:o=>{const h=e.value.find(s=>s.id===o);h&&!h.isRead&&(h.isRead=!0,h.readAt=new Date().toISOString(),t.value=Math.max(0,t.value-1))},markAllAsRead:()=>{e.value.forEach(o=>{o.isRead||(o.isRead=!0,o.readAt=new Date().toISOString())}),t.value=0},removeNotification:o=>{const h=e.value.findIndex(s=>s.id===o);h!==-1&&(e.value[h].isRead||(t.value=Math.max(0,t.value-1)),e.value.splice(h,1))}}}function se(){const e=W(!1),t=W(null);let i=null;const a=[],p=async()=>{if(i)return;const h=Q(),s="admin/reviews";try{i=h.subscription(s),await i.create(),i.onMessage(E=>{E.event==="review_replied"&&(t.value=E,a.forEach(V=>V(E)))}),e.value=!0}catch(E){console.error("Failed to connect to admin reviews channel:",E),e.value=!1}},F=async()=>{i&&(await i.delete(),i=null,e.value=!1)},o=h=>(a.push(h),()=>{const s=a.indexOf(h);s>-1&&a.splice(s,1)});return X(()=>{p()}),$(()=>{F(),a.length=0}),{isConnected:e,lastReplyUpdate:t,connect:p,disconnect:F,onReplyReceived:o}}export{se as a,ie as u};
